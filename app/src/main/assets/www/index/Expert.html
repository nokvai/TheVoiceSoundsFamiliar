<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!--<script src='../js/jquery-3.2.1.js' type='text/javascript'></script>-->
    <!--<script src='../js/musicHelper.js' type='text/javascript'></script>-->
    <!--<script src='../js/clickSound.js' type='text/javascript'></script>-->
    <!--<link href="../css/CustomStyles.css" rel="stylesheet" type="text/css" >-->
    <script src='file:///android_asset/www/js/jquery-3.2.1.js' type='text/javascript'></script>
    <script src='file:///android_asset/www/js/musicHelper.js' type='text/javascript'></script>
    <script src='file:///android_asset/www/js/clickSound.js' type='text/javascript'></script>
    <link href="file:///android_asset/www/css/CustomStyles.css" rel="stylesheet" type="text/css" >
    <script>
        $(document).ready(function() {

            function showTheme() {
                $("body").css({"background-image": "url(" + mygame.getChangeTheme(Number(1)) + ")"});
                $("body").addClass("bg");
             } showTheme();

			$("#finishedLevel").hide();
			var player_id = "";
			var question_no = "";
			var level = "";
			var UsedHint = 0;
			var usedH1 = 0;
			var usedH2 = 0;
			var usedH3 = 0;
			var downloadTimer;
			var deleteSong = "";
			var song = "";
            var titleLengthRandom = [];
            var falseInorder = [];
            var falseCount = 0;
            var finalTitle = "";
            var charCount = 0;
            var generateTitle = "";

			function setValue(level, id) {
				var queryString = "?level=" + level + "&id=" + id;
				window.location.href = "file:///android_asset/www/index/Level30.html" + queryString;
			}

			function setValue20(level, id) {
				var queryString = "?level=" + level + "&id=" + id;
				window.location.href = "file:///android_asset/www/index/Level20.html" + queryString;
			}

			function setValueReward(level, id) {
				var queryString = "?level=" + level + "&id=" + id;
				window.location.href = "file:///android_asset/www/index/Reward.html" + queryString;
			}

			function getValue() {
				var queryString = decodeURIComponent(window.location.search);
					queryString = queryString.substring(1);
					var queries = queryString.split("&");
					var result = [];
					for (var i = 0; i < queries.length; i++) {
					  result.push( queries[i].split("=") );
					}
				return result;
			}

			question_no = getValue()[0][1];
			player_id = getValue()[1][1];
			level = getValue()[2][1];

			var player = mygame.getPlayer(Number(player_id)).split(',');
			$("#questionNo").text( parseInt(question_no) + 1 );
			$("#playerName").text(player[1]);

			if (Number(question_no) != 60) {
				song = mygame.getSongByIdLevelIndex(Number(player_id), level, Number(question_no)).split(',');
                var song_clean = song[1].split('-')[0].split('_').join(' ');
                var expert = mygame.getExpertQuestionSong(song_clean).split(',');
                    var tlr = expert[0].split('@');
                    for(var j=0; j < (tlr.length - 1); j++) {
                        titleLengthRandom.push(tlr[j]);
                    }
                    var fi = expert[1].split('$');
                    for(var k=0; k < (fi.length - 1); k++) {
                        falseInorder.push(fi[k]);
                    }
                    falseCount = Number(expert[2]);
                    finalTitle = expert[3];
                    $("#songTitle").text(finalTitle);
                    generateTitle = finalTitle;
			}

			function enableSubmit() {
			    if (generateTitle != finalTitle) {
			         $("#btnSubmit").show();
			    } else if ( generateTitle == finalTitle ) {
			      $("#btnSubmit").hide();
			    }
			}

			 function addBlank(letter) {
                try {
                    if ( charCount < falseCount) {
                        finalTitle = mygame.replaceCharAt(finalTitle, Number(falseInorder[charCount]), letter);
                        $("#songTitle").text(finalTitle);
                        charCount++;
                    } else {
                        charCount = falseCount;
                    }
                } catch(err) {
                    charCount = falseCount;
                }
                enableSubmit();
            }

            function removeLast() {
                try {
                    if ( charCount >= 0) {
                        charCount--;
                        finalTitle = mygame.replaceCharAt(finalTitle, Number(falseInorder[charCount]), "_");
                         $("#songTitle").text(finalTitle);
                    } else {
                        charCount = 0;
                    }
                }  catch(err) {
                    charCount = 0;
                }
                enableSubmit();
            }

			function hint1() {
				var correctAnswer = song[1].split('-')[0].split('_').join(' ');
				$("#btnHint1").text("Given letter: " + mygame.getAdvanceHintGiveOneLetter(correctAnswer) );
				usedH1 = 1;
			}

			function hint2() {
				clearInterval(downloadTimer);
				Play(10);
				usedH2 = 1;
			}

			function hint3() {
			    var songtitle = song[1].split('-')[0].split('_').join(' ');
                $("#btnHint3").text("Given letter: " + mygame.getAdvanceHintGiveTwoLetter( songtitle, Number(falseCount), falseInorder ) );
				usedH3 = 1;
			}

			function disableHint() {
				var songs = mygame.getFinishedSongsByIdLevelIndex(Number(player_id), level).split(',');
				var cnt_hint = 0;
				for(var z=0;z < (songs.length - 1); z++ ) {
					var s = songs[z].split('&');
					var index = (Number(s[2]) + 1);
					if (Number(s[5]) > 0) {
						cnt_hint++;
					}
					var h = Number(s[5]);
					if (h == 1) { $("#btnHint1").css({"display": "none"}); }
					else if (h == 2) { $("#btnHint2").css({"display": "none"}); }
					else if (h == 3) { $("#btnHint3").css({"display": "none"}); }
					else if (h == 12) { $("#btnHint1").css({"display": "none"}); $("#btnHint2").css({"display": "none"});  }
					else if (h == 13) { $("#btnHint1").css({"display": "none"}); $("#btnHint3").css({"display": "none"});  }
					else if (h == 21) { $("#btnHint2").css({"display": "none"}); $("#btnHint1").css({"display": "none"});  }
					else if (h == 23) { $("#btnHint2").css({"display": "none"}); $("#btnHint3").css({"display": "none"});  }
					else if (h == 31) { $("#btnHint3").css({"display": "none"}); $("#btnHint1").css({"display": "none"});  }
					else if (h == 32) { $("#btnHint3").css({"display": "none"}); $("#btnHint2").css({"display": "none"});  }
					else if (h == 123) { $("#btnHint1").css({"display": "none"}); $("#btnHint2").css({"display": "none"});  $("#btnHint3").css({"display": "none"}); }
				}
			}

			function showPoints() {
					var songs = mygame.getFinishedSongsByIdLevelIndex(Number(player_id), level).split(',');
					var score = 0;
					var cnt_wrong = 0;
					var cnt_hint = 0;
					var hint_subtract = 0;
					for(var z=0;z < (songs.length - 1); z++ ) {
						var s = songs[z].split('&');
						var index = (Number(s[2]) + 1);
						if (Number(s[5]) > 0) {
							cnt_hint++;
						}
						if (Number(s[6]) == 0) {
							cnt_wrong++;
						}
						score += Number(s[6]);
					}
					if( cnt_hint == 1 ) { hint_subtract = 40; }
					else if( cnt_hint == 2 ) { hint_subtract = 80; }
					else if( cnt_hint == 3 ) { hint_subtract = 120; }
					score = Number(score);
				    player = mygame.getPlayer(Number(player_id)).split(',');
					var playerScore = Number(player[3]);
					var total = ( (playerScore + score) - hint_subtract );
					//var total = ( score - hint_subtract );

					$("body div").hide();
					$("#finishedLevel").show();
					$("#initialPoints").text("Initial Points: " + playerScore);
					$("#earnedPoints").text("Earned Points: " + score);
					$("#wrongAnswers").text("Wrong Answers: " + cnt_wrong);
					$("#deductions").text("Deducted Points: " + hint_subtract);
					$("#finalScore").text("Total Points: " + total);
					$("#btnBack").show();
			}

			function getSelectedAnswer() {
						var correctAnswer = song[1].split('-')[0].split('_').join(' ');
						var selectedAnswer = $("#songTitle").text();
						if (usedH1 > 0) { UsedHint = 1; }
						else if (usedH2 > 0) { UsedHint = 2; }
						else if (usedH3 > 0) { UsedHint = 3; }
						else if ( (usedH1 > 0) && (usedH2 > 0) ) { UsedHint = 12; }
						else if ( (usedH1 > 0) && (usedH3 > 0) ) { UsedHint = 13; }
						else if ( (usedH2 > 0) && (usedH1 > 0) ) { UsedHint = 21; }
						else if ( (usedH2 > 0) && (usedH3 > 0) ) { UsedHint = 23; }
						else if ( (usedH3 > 0) && (usedH1 > 0) ) { UsedHint = 31; }
						else if ( (usedH3 > 0) && (usedH2 > 0) ) { UsedHint = 32; }
						else if ( (usedH1 > 0) && (usedH2 > 0) && (usedH2 > 0)) { UsedHint = 123; }
						if ( selectedAnswer.toLowerCase() == correctAnswer.toLowerCase() ) {
							mygame.updateSongByIdLevelIndex(Number(player_id), level, Number(question_no), Number("1"), UsedHint, Number("5"), Number("1"));
						} else {
							mygame.updateSongByIdLevelIndex(Number(player_id), level, Number(question_no), Number("0"), UsedHint, Number("0"), Number("1"));
						}

						var songs = mygame.getFinishedSongsByIdLevelIndex(Number(player_id), level).split(',');

						var dbsongs = mygame.getSongs(Number(player_id), level).split(',');
					    var dblength = (dbsongs.length - 1);
						if (dblength == 30) {
							if( Number(songs.length - 1) < 30 ) {
								setTimeout(function() {
									setValue(level, player_id);
								}, 400);
							} else if ( Number(songs.length - 1) == 30 ) {
								showPoints();
							}
						}
						else if (dblength == 50) {
							if( Number(songs.length - 1) < 50 ) {
								setTimeout(function() {
									setValue20(level, player_id);
								}, 400);
							} else if ( Number(songs.length - 1) == 50 ) {
								showPoints();
							}
					    }

			}

			function checkEnableHint() {
				var songs = mygame.getFinishedSongsByIdLevelIndex(Number(player_id), level).split(',');
				var score = 0;
				var cnt_wrong = 0;
				var cnt_hint = 0;
				var hint_subtract = 0;
				for(var z=0;z < (songs.length - 1); z++ ) {
					var s = songs[z].split('&');
					var index = (Number(s[2]) + 1);
					if (Number(s[5]) > 0) {
						cnt_hint++;
					}
					if (Number(s[6]) == 0) {
						cnt_wrong++;
					}
					score += Number(s[6]);
				}
				if( cnt_hint == 1 ) { hint_subtract = 40; }
				else if( cnt_hint == 2 ) { hint_subtract = 80; }
				else if( cnt_hint == 3 ) { hint_subtract = 120; }

				score = ( Number(score) - Number(hint_subtract) );
				var player = mygame.getPlayer(Number(player_id)).split(',');
				var playerScore = Number(player[3]);
				var total = ( (playerScore + score) - hint_subtract );
				//var total = ( score - hint_subtract );

				if (total < 40) {
					$("#btnHint").hide();
				} else if (total >= 40) {

					$("#btnHint").show();
				}
			}

			function Play(sec) {
				var timeleft = sec;
				 downloadTimer = setInterval(function() {
					$("#secondsLeft").text("Seconds Left: " + timeleft);
					$("#progressBarSeconds").val( timeleft );
					if (timeleft >= sec) {
						$("#progressBarSeconds").css({"display": "inline"});
						playExpertMusic(song[1]);
					} else if (timeleft == 0) {
						$("#progressBarSeconds").css({"display": "none"});
						stopAudio();
					}
					--timeleft;
					if(timeleft < 0)
					clearInterval(downloadTimer); },1000);
			}

			$("#btnBack").click(function() {
                clickSound();
                setTimeout(function() {
                    setValue(level, player_id);
                }, 400);
            });

			$("#btnSubmit").click(function() {
                clickSound();
				getSelectedAnswer();
            });

			$("#btnHint").click(function() {
				if ($("#hintBox").hasClass('hide-hint') ) {
					$("#hintBox").removeClass('hide-hint');
					$("#hintBox").addClass('show-hint');
				} else {
					$("#hintBox").removeClass('show-hint');
					$("#hintBox").addClass('hide-hint');
				}
            });

			$("#btnHint1").click (function() {
				hint1();
				setTimeout(function() {
                	$("#btnHint1").css({"display": "none"});
				    $("#hintBox").addClass('hide-hint');
                }, 5000);
			});
			$("#btnHint2").click (function() {
				hint2();
				$("#btnHint2").css({"display": "none"});
				$("#hintBox").addClass('hide-hint');
			});
			$("#btnHint3").click (function() {
				hint3();
				setTimeout(function() {
                	$("#btnHint3").css({"display": "none"});
					$("#hintBox").addClass('hide-hint');
                }, 5000);
			});

			$("#btnFinish").click(function() {
				setTimeout(function() {
					setValue(level, player_id);
				}, 400);
			});

            $("#btnReward").click(function() {
				setTimeout(function() {
				    setValueReward(level, player_id);
					//window.location.href = "file:///android_asset/www/index/Reward.html";
				}, 400);
			});

			$("#btnQ").click(function() { addBlank("q"); });
			$("#btnW").click(function() { addBlank("w"); });
			$("#btnE").click(function() { addBlank("e"); });
			$("#btnR").click(function() { addBlank("r"); });
			$("#btnT").click(function() { addBlank("t"); });
			$("#btnY").click(function() { addBlank("y"); });
			$("#btnU").click(function() { addBlank("u"); });
			$("#btnI").click(function() { addBlank("i"); });
			$("#btnO").click(function() { addBlank("o"); });
			$("#btnP").click(function() { addBlank("p"); });

			$("#btnA").click(function() { addBlank("a"); });
			$("#btnS").click(function() { addBlank("s"); });
			$("#btnD").click(function() { addBlank("d"); });
			$("#btnF").click(function() { addBlank("f"); });
			$("#btnG").click(function() { addBlank("g"); });
			$("#btnH").click(function() { addBlank("h"); });
			$("#btnJ").click(function() { addBlank("j"); });
			$("#btnK").click(function() { addBlank("k"); });
			$("#btnL").click(function() { addBlank("l"); });

			$("#btnZ").click(function() { addBlank("z"); });
			$("#btnX").click(function() { addBlank("x"); });
			$("#btnC").click(function() { addBlank("c"); });
			$("#btnV").click(function() { addBlank("v"); });
			$("#btnB").click(function() { addBlank("b"); });
			$("#btnN").click(function() { addBlank("n"); });
			$("#btnM").click(function() { addBlank("m"); });
			$("#btnBackspace").click(function() { removeLast(); });

			disableHint();
			checkEnableHint();
			Play(10);

			if (Number(question_no) == 60) {  stopAudio();  showPoints();  }
		});

    </script>
</head>

<body>
<div class="circle-text" style="float: left; margin-left: 10px; margin-top: 10px;">
    <b id="questionNo" style="position: relative; top: 20px;">1</b>
</div>

<img style="position: absolute; top: 10px; left: 110px; height: 80px;" src="../image/ic_launcher.png" />

<div class="rectangle-text" style="float: right; margin-right: 10px; margin-top: 15px;">
    <b id="secondsLeft" style="position: relative; top:15px;">Seconds Left: 0</b>
    <progress id="progressBarSeconds" style="position: relative; margin-top: 40px;" value="10" max="10" ></progress>
</div>

<div class="rectangle-text" style="float: right; margin-right: 5px; margin-top: 15px;">
    <b id="playerName" style="position: relative; top:15px;"></b>
</div>

<div id="finishedLevel" style="text-align: center; position: relative; top: 90px; display: none;">
    <h1 style="text-align:center; color: orange; ">Expert level Completed!!!</h1>

    <h2 style="color: blue; font-family: 'Lucida Console', Times, serif; font-weight: bold; font-size: 20px;" id="initialPoints">Initial Points: </h2>
    <h2 style="color: green; font-family: 'Lucida Console', Times, serif; font-weight: bold; font-size: 20px;" id="earnedPoints">Earned Points: </h2>
    <h2 style="color: red; font-family: 'Lucida Console', Times, serif; font-weight: bold; font-size: 20px;" id="wrongAnswers">Wrong Answers: </h2>
    <h2 style="color: violet; font-family: 'Lucida Console', Times, serif; font-weight: bold; font-size: 20px;" id="deductions">Deducted Points: </h2>
    <h2 style="font-family: 'Lucida Console', Times, serif; font-weight: bold; font-size: 18px;" id="finalScore">Total Points: </h2>
    <button id="btnFinish" class="button-nav">Finish</button>
    <button id="btnReward" class="button-nav">Reward</button>
</div>

<div style="text-align: center; position: absolute; top: 25%; left: 10%;">
    <h1 id="songTitle" style="letter-spacing: 3px; color: green;">Your Song Title</h1>
    <div style="text-align:center; margin-top: -20px;">
        <button id="btnQ" class="button-letter">Q</button>&nbsp;
        <button id="btnW" class="button-letter">W</button>&nbsp;
        <button id="btnE" class="button-letter">E</button>&nbsp;
        <button id="btnR" class="button-letter">R</button>&nbsp;
        <button id="btnT" class="button-letter">T</button>&nbsp;
        <button id="btnY" class="button-letter">Y</button>&nbsp;
        <button id="btnU" class="button-letter">U</button>&nbsp;
        <button id="btnI" class="button-letter">I</button>&nbsp;
        <button id="btnO" class="button-letter">O</button>&nbsp;
        <button id="btnP" class="button-letter">P</button>&nbsp;
    </div>
    <div style="text-align:center; position: relative; top: 40%;">
        <button id="btnA" class="button-letter">A</button>&nbsp;
        <button id="btnS" class="button-letter">S</button>&nbsp;
        <button id="btnD" class="button-letter">D</button>&nbsp;
        <button id="btnF" class="button-letter">F</button>&nbsp;
        <button id="btnG" class="button-letter">G</button>&nbsp;
        <button id="btnH" class="button-letter">H</button>&nbsp;
        <button id="btnJ" class="button-letter">J</button>&nbsp;
        <button id="btnK" class="button-letter">K</button>&nbsp;
        <button id="btnL" class="button-letter">L</button>&nbsp;
    </div>
    <div style="text-align:center; position: relative; top: 48%;">
        <button id="btnZ" class="button-letter">Z</button>&nbsp;
        <button id="btnX" class="button-letter">X</button>&nbsp;
        <button id="btnC" class="button-letter">C</button>&nbsp;
        <button id="btnV" class="button-letter">V</button>&nbsp;
        <button id="btnB" class="button-letter">B</button>&nbsp;
        <button id="btnN" class="button-letter">N</button>&nbsp;
        <button id="btnM" class="button-letter">M</button>&nbsp;
        <button id="btnBackspace" class="button-letter">Backspace</button>&nbsp;
    </div>
</div>

<div id="hintBox" class="hide-hint" style="position: absolute; top: 32%; left: 40%; width: 320px; height: 150px; border-radius: 12px; background-color: #0074d9;">
    <button id="btnHint1" class="button-hint">give one letter of the song title</button>
    <button id="btnHint2" class="button-hint">play music again in 15 seconds</button>
    <button id="btnHint3" class="button-hint">give 2 letters of the song title.</button>
</div>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<div class="center-div">
    <button id="btnBack"  class="button-nav" style="display: none;">Back</button> &nbsp;&nbsp;&nbsp;
    <button id="btnSubmit"  class="button-nav" style="display: none;">Submit</button>&nbsp;&nbsp;
    <button id="btnHint"  class="button-nav">Hint</button>&nbsp;&nbsp;&nbsp;
</div>
</body>
</html>
